var signPluginTp=signPluginTp||{};signPluginTp.extend=function(b,a){for(var c in a){b[c]=a[c]}};signPluginTp.SignPlugin=function(b){this._options={pluginID:"plugin",method:"urn:xmldsig:transformation:v1.1",tokenTypeCallback:function(c){},signErrorCallback:function(c,d){},signSuccessCallback:function(e,c,d){},signStepProcessBeginCallback:function(){},signStepProcessDoneCallback:function(){},promtPasswordCallback:function(){},pluginItem:null};var a=this._options;this.tokenTypes={CSP:new Token({errorCodes:{0:"OK",1:"Ошибка открытия хранилища сертификатов",2:"Ошибка копирования контекста сертификата",3:"Ошибка удаления сертификата из хранилища",4:"Ошибка закрытия хранилища сертификатов",5:"Ошибка освобождения контекста сертификата",6:"Ошибка получения контекста CSP",7:"Ошибка получения контекста CSP для контейнера",8:"Ошибка получения имени CSP",9:"Ошибка получения типа CSP",10:"Ошибка освобождения контекста CSP для контейнера",11:"Ошибка освобождения контекста CSP",12:"Ошибка получения ключа",13:"Ошибка получения параметров ключа",14:"Ошибка выделения памяти для сертификата",15:"Ошибка получения параметров ключа 2",16:"Ошибка создания контекста сертификата",17:"Ошибка задания свойств контекста сертификата",18:"Ошибка посещения контекста сертификата в хранилище",19:"Ошибка удаления ключа",20:"Ошибка выбора сертификата из хранилища",21:"Ошибка получения имени из сертификата",22:"Ошибка поиска сертификата",23:"Ошибка получения закрытого ключа из контекста сертификата",24:"Ошибка создания ЭЦП сообщения",25:"Ошибка выделения памяти для ЭЦП сообщения",26:"Ошибка создания ЭЦП сообщения 2",27:"Ошибка выделения памяти для BASE64",28:"Ошибка кодирования BASE64",29:"Ошибка выделения памяти для имени CSP",30:"Ошибка перебора CSP",31:"Ошибка данных",32:"Ошибка создания ключа",33:"Ошибка извлечения хэша открытого ключа",34:"Ошибка кодирования объекта",35:"Ошибка подписи и кодирования сертификата",36:"Ошибка экспорта данных открытого ключа",37:"CSP не поддерживается",38:"Ошибка конвертации строки в имя сертификата",39:"Ошибка открытия файла",40:"Неверный размер файла",41:"Ошибка данных",42:"Неверное имя файла",43:"Ошибка хэширования",44:"Ошибка получения параметров хэша",45:"Ошибка подписи хэша",46:"Ошибка задания параметров ключа",47:"Ошибка задания параметров CSP",48:"Ошибка получения свойств контекста сертификата"},getCertificate:function(){var c=a.pluginItem.cspCertificate;
this.checkError();return c},prepareStore:function(){var c=navigator.userAgent.toLowerCase().indexOf("kraftway")!=-1;var d=c?a.pluginItem.cspPrepareStore():a.pluginItem.cspFillStore();return 1==d},signData:function(d){this.prepareStore();var c=a.pluginItem.cspSignDataAny(d,1);this.checkError();return c},signHashData:function(d){this.prepareStore();var c=a.pluginItem.cspHashSignDataAny(d)[2];this.checkError();return c},getErrorCode:function(){return a.pluginItem.cspErrorCode}}),ETOKEN:new Token({errorCodes:{0:"OK",1:"Ошибка инициализации библиотек Аладдин",2:"Ошибка получения кол-ва слотов",3:"Ошибка получения списка слотов",4:"Слот не найден",5:"Ошибка открытия сессии",6:"Ошибка авторизации",7:"Ошибка создания ключевой пары",8:"Ошибка создания CSR",9:"Ошибка выделения памяти для BASE64",10:"Ошибка кодирования BASE64",11:"Ошибка инициализации токена",12:"Ошибка инициализации PIN",13:"Ошибка декодирования BASE64",14:"Ошибка создания объекта",15:"Ошибка инициализации поиска объектов",16:"Ошибка поиска объектов",17:"Ошибка финализации поиска объектов",18:"Ошибка удаления объекта",19:"Некорректный номер слота",20:"Некорректный id объекта",21:"Некорректный PIN админа",22:"Некорректный PIN пользователя",23:"Некорректная метка токена",24:"Некорректная сертификат",25:"Некорректное ФИО",26:"Некорректный СНИЛС",27:"Некорректные данные",28:"Сертификат не найден",29:"Ошибка создания ЭЦП PKCS7",30:"Ошибка получения информации сертификата",31:"Ошибка получения значения атрибута",32:"Ошибка смены PIN",33:"Ошибка данных",34:"Ошибка получения информации токена",35:"Ключ не найден",36:"Данные не найдены",37:"Ошибка инициализации генерации хэша",38:"Ошибка генерации хэша",39:"Ошибка инициализации генерации ЭЦП",40:"Ошибка генерации хэша"},getPassword:function(){return a.promtPasswordCallback()
},certificateId:null,certificate:null,getCertificateId:function(){if(!this.certificateId){this.certificateId=1;this.certificate=a.pluginItem.etgGetCertificate(1,this.certificateId,this.getPassword());if(28==this.getErrorCode()){this.certificateId=99;this.certificate=a.pluginItem.etgGetCertificate(1,this.certificateId,this.getPassword())}if(0!=this.getErrorCode()){this.certificate=null;this.certificateId=null}this.checkError()}return this.certificateId},getCertificate:function(){return this.getCertificateId()&&this.certificate},signData:function(d){var c=a.pluginItem.etgSignDataAny(1,this.getCertificateId(),this.getPassword(),d,1);this.checkError();return c},signHashData:function(d){var c=a.pluginItem.etgHashSignDataAny(1,this.getCertificateId(),this.getPassword(),d)[1];this.checkError();return c},getErrorCode:function(){return a.pluginItem.etgErrorCode}})};this.token=null;signPluginTp.extend(this._options,b)};Token=function(a){this.errorCodes={};signPluginTp.extend(this,a)};Token.prototype={getCertificate:function(){},signData:function(a){},signHashData:function(a){},getErrorCode:function(){},checkError:function(a){a=a||this.getErrorCode();
if(a!=0){throw new TokenException(a,this.errorCodes[a])}}};TokenException=function(a,b){this.code=a;this.msg=b};signPluginTp.SignPlugin.prototype={init:function(){var a=document.getElementById(this._options.pluginID);this._options.pluginItem=a;if(a.etgSlotCount>0){this.token=this.tokenTypes.ETOKEN}if(a.cspKeyContainerCount>0){this.token=this.tokenTypes.CSP}if(!this.token){this.token=this.tokenTypes.CSP}this._options.tokenTypeCallback(this.token)},makeSign:function(d,e){if(this._options.pluginItem){this._options.signStepProcessBeginCallback();try{var b=this.token.signHashData(d);var a=this.token.getCertificate();this._options.signSuccessCallback(e,b,a)}catch(c){this.processError(c)}finally{this._options.signStepProcessDoneCallback()}}else{this._options.signErrorCallback(500,"Error processing digest data response")}},makeSignPKCS7:function(c){if(this._options.pluginItem){this._options.signStepProcessBeginCallback();try{var a=this.token.signData(c);this._options.signSuccessCallback(null,a,null)
}catch(b){this.processError(b)}finally{this._options.signStepProcessDoneCallback()}}else{this._options.signErrorCallback(500,"Plugin not defined")}},processError:function(b){this._options.signErrorCallback(b.code,b.msg);switch(b.code){case 6:if(this.tokenTypes.CSP==this.token){AchtungDialog.show({title:"Предупреждение",subtitle:"Уважаемый пользователь Портала!",content:"Для подписания декларации вам необходимо установить последнюю версию Крипто Про.",buttons:[{text:"Закрыть",callback:function(){AchtungDialog.hide()},params:{"class":"buttonClass"}}]})}break;case 33:case 36:if(this.tokenTypes.ETOKEN==this.token){var a=this._options.pluginItem.version.substring(this._options.pluginItem.version.lastIndexOf(".")+1);if(a<9){AchtungDialog.show({title:"Предупреждение",subtitle:"Уважаемый пользователь Портала!",content:'Для подписания декларации вам необходимо установить последнюю версию <a href="/pgu/docs/pluginUploadIE">плагина ЭП</a>.',buttons:[{text:"Закрыть",callback:function(){AchtungDialog.hide()
},params:{"class":"buttonClass"}}]})}}break}}};