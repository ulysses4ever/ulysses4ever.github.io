$(function(){var n=$(".region_indicator"),u={};$("a",n).click(function(){$(".region").trigger("show");return false});n.bind("changeRegion",function(x,y){var w="/pgu/cat/TERRITORY/"+y.regionCode+"/path.json";$.getJSON(w,function(A){var z=$.map(A,function(B){return B.title}).join(" / ");n.find("a").attr("title",z)})});var f;var p={title:"Российская Федерация",id:"00000000000"};$(".region .region_item.rf").data(p);var s=$(".region .region_list");var c=$(".region .search input");var t="";$(".region .region_item").live("click",function(){var w=$(this).data();if(f.id==p.id&&w.id==p.id){g();return}if(t==""){t=w.id}d(w,function(x){x.length||g()})});function m(x,z,y){if(y&&y!=p.id){var w=x.slice(0);w.sort(function(B,A){return B.id-A.id});$.each(w,function(A,B){B.tryIco=A})}$.each(x,function(C,D){D.ico=D.ico||99;var B=$("#region_item").tmpl(D).appendTo(s);B.data(D);z&&B.addClass(z);if(y&&y!=p.id){var A=B.find("span.icon");A.css("backgroundImage",'url("/pgu/htdocs/img/2012/gerb_regions/'+y+'.jpg")');
A.css("backgroundPosition","0px -"+(D.tryIco*48)+"px")}})}$(".region").bind("show",function(){if($(".region").is(":visible")){return}d(p,function(){$("#content").hide();$(".crumbsWrapper").hide();$(".region").show();$(".region_crumbs").show();c.focus()})});function q(){return $.trim(c.val().replace(/[^\wа-я]+/ig," "))}c.change(e);var r=500,k,j=2;c.keyup(function(){clearTimeout(k);k=setTimeout(e,r)});function i(w){$(".region .search .loading")[w?"addClass":"removeClass"]("active")}var h;function e(){var B=q();var A=B.toLowerCase().split(/[^а-я]/i);var x=z(A);var y={};var D=$(".region .region_item").not(".rf");if(B==h){return}$(".region .region_search_item").remove();if(B.length<j){D.show();h=B;return}D.hide().filter(function(){return false}).show();function z(E){var F="([^а-я]|^)";return $.map(E,function(G){return G?new RegExp(F+"("+w(G)+")","i"):null})}function C(G,F){var E=true;$.each(F,function(H,I){return E&=I.test(G)});return E}function w(E){return E.replace(/[\/|()*+?$^{}\[\].]/g,function(F){return"\\"+F
}).replace(/\n/g,"\\n")}l(x);o();if(B.length>=j){v(f.id,B,function(E){if(q()!=B){return}E=$.map(E,function(F){if(y[F.id]){return null}if(!F.isSearchResult){F.title=F.title+(F.pathString||"").split("/")[0].replace(/(^.)/," - $1")}F.isSearchResult=true;return F}).slice(0,20);$(".region .region_search_item").remove();m(E,"region_search_item");l(x);o()})}h=B}function l(w){$(".region .region_item:visible td").not(".icon").each(function(){var x=$(this);x.attr("text",x.attr("text")||x.text());var y=$(this).attr("text");$.each(w,function(z,A){y=y.replace(A,'$1<b style="color:#c55">$2</b>')});x.html(y)})}function o(){$(".region .region_item:visible").each(function(){var y=$(this);var x=y.find(".region_item_text");x.css("padding","4px 0");if($.browser.msie){x.css("paddingBottom","8px")}var w=parseInt(x.css("fontSize"));while(--w&&x.outerHeight()>y.height()){x.css("fontSize",w)}})}v.cache={};function v(A,E,D,B){var x=v.cache;var y=v.serial=1+(v.serial||0);i(true);var C=A+":"+E;if(x[C]){var z=x[C];
z.serial=v.serial;w(x[C])}else{$.ajax({url:"/pgu/cat/TERRITORY/"+A+"/searchChildren.json",data:{serial:y,q:E,filteringType:"SUBTREE"},type:"POST",success:w,error:function(){B&&B.apply(this,arguments);i(false)}})}function w(F){x[C]=F;if(F.serial==v.serial){D(F.items||[]);i(false)}return true}}var b={stack:[],refresh:function(){var w=this.stack.concat([a]);$(".region_crumbs").trigger("set",[w])},_push:function(w){w=$.extend({url:"#",init:function(){$("a",this).click(function(){d(w);return false})}},w);this.stack.push(w);w.path=this.stack.slice();this.refresh()},set:function(w){this.stack=[];$.each(w,function(x,y){b._push(y)})}};var a={tmpl:"#region_select_button",init:function(){$("button",this).click(g)}};d.cache={};function d(x,A){var w=d.cache;var z=(x.id==p.id&&[p])||x.path||b.stack.concat(x);if(w[x.id]){y.call(this,w[x.id])}else{(x===p)?Shadow.show():i(true);$.ajax({url:"/pgu/cat/TERRITORY/"+x.id+"/children.json",type:"GET",dataType:"json",success:function(B){(x===p)?Shadow.hide():i(false);
return y.apply(this,arguments)},error:function(){(x===p)?Shadow.hide():i(false)}})}t=(x.id===p.id)?"":t;function y(B){w[x.id]=B;var C=s.find(".region_item.rf");C.nextAll().remove();(x.id===p.id)?C.show():C.hide();m(B,null,x.id);b.set(z);c.val("").change().focus();f=x;A&&A(B)}}function g(){Shadow.show();$.ajax({url:"/pgu/service/setSelectedRegion.html",data:{selectedRegion:f.id},type:"POST",dataType:"json",success:function(x){f.id=x.selectedRegion;$(".region_indicator a").text(x.selectedRegionName);$(".region_indicator").trigger("changeRegion",{regionCode:x.selectedRegion,regionName:x.selectedRegionName});$("#content").show();$(".crumbsWrapper").show();$(".region").hide();$(".region_crumbs").hide();var w=x.selectedRegion;if(w&&w!="00000000000"){if(w.substring(0,2)!="11"&&w.substring(0,2)!="71"){w=w.substring(0,2)}else{w=t.substring(0,4)}$(".footer .gerb").css("background-image","url(/pgu/htdocs/img/2012/gerb_regions/gerb_"+w+".png)")}else{if(w=="00000000000"){$(".footer .gerb").css("background-image","none")
}}t="";Shadow.hide()},error:function(){}})}$(".region_crumbs").each(function(){var w=[],y={};var x=$(this).bind("refresh",function(){x.empty();$.each(w,function(z,A){A.first=!z;A.last=(z==w.length-1);$el=$(A.tmpl||"#crumbs_item").tmpl(A).appendTo(x);A.init&&$el.each(A.init)})}).bind("empty",function(){w=[];$(this).triggerHandler("refresh")}).bind("set",function(A,z){w=z||[];$(this).triggerHandler("refresh")}).bind("push",function(){var z=Array.prototype.slice.call(arguments,1);while(z.length){w.push(z.shift())}$(this).triggerHandler("refresh")}).bind("pop",function(A,z){z=z||1;while(z--){w.pop()}$(this).triggerHandler("refresh")});x.triggerHandler("set",[y.stack])})});