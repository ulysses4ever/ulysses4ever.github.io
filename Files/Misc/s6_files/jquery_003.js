(function(a){a.clonable={collection:[],checkButtonsVisibility:function(){a.each(a.clonable.collection,function(){var c=this.opts,d=a([]);var b=this.$.filter(function(){var e=a(this).is(c.buttonsSection);if(!e&&a(this).is(":visible")){d=d.add(this)}return e});b[d.length?"show":"hide"]()})},_def:{buttonsSection:"tr.clone-buttons-section",appendBtn:"div.clone-button-append",deleteBtn:"div.clone-button-delete",hideButtonSections:false,maxContainerSize:10,reindexNodes:".clone-field",reindexCheckboxNodes:"ul.checkListNew input:hidden",reindexRadioNodes:"ul.radioListNew input:radio, *:has(ul.radioListNew) input:hidden",reindexLookupNodes:"a[id$=-lookup-form-clear-button]",reindexErrNodes:"div[id$=-err], div[id$=-err] label.error",reindexFileNodes:"input:hidden[id$=.fileName], input:hidden[id$=.fileID], input:hidden[name=fileDataStub]"},initClone:function(c,b){a.clonable.initDatepicker.apply(this,[c,b]);a.clonable.initLookup.apply(this,[c,b]);a.clonable.initFileInput.apply(this,[c,b]);a("ul.checkListNew",this).checkBox();
a("ul.radioListNew",this).radioGroup();a.descriptor.runProcess()},initDatepicker:function(f,b,e){if(b){var d="["+b+"]";var c="["+0+"]"}a("input.date-field",this).each(function(){var n=a(this);if(b){var h=a(this).attr("id");h=h.replace(d,c);var l=a(document.getElementById(h)).data("datepicker");e=l.settings}var j=e?e.changeMonth:true;var o=e?e.changeYear:true;var q=e?e.yearRange:"c-100:c+20";var k=e&&e.minDate?e.minDate:null;var g=e&&e.maxDate?e.maxDate:null;var i=n.val();var m={};if(k){m.minDate=k}if(g){m.maxDate=g}var p=a.extend({},m,{changeMonth:j,changeYear:o,yearRange:q,beforeShow:function(r,s){a(r).unbind("blur");if(s){if(a(r).attr("readonly")){s.inline=true}else{s.inline=false}}},onClose:function(s,r){if(r._keyEvent){n.trigger("change")}n.trigger("focusout");n.trigger("blur")},onSelect:function(s,r){if(r&&r.lastVal!=s){n.trigger("change")}}});n.datepicker(p);i&&n.val()!=i&&n.val(i)})},destroyDatepicker:function(){var b={};a("input.date-field",this).each(function(c){if(c===0){b=a(this).data("datepicker").settings
}a(this).datepicker("destroy")});return b},initLookup:function(){a("input[id$=-lookup-form-text]",this).each(function(){var e=a(this).attr("id").replace(/-lookup-form-text$/,"");var b=e.replace(/\[\d+\]$/,"[0]");var c=a.extend(true,{},LookupWidget.registry.getRecord(b).config,{resultFieldId:e,baseId:e+"-lookup"});var d=LookupWidget.registry.createRecord(e,c);d.widget=new LookupWidget(d.config);d.widget.init();d.widget.__options.promptText=d.widget.__options.promptText||"[Выбрать]"})},destroyLookup:function(){a("input[id$=-lookup-form-text]",this).each(function(){var b=a(this).attr("id").replace(/-lookup-form-text$/,"");LookupWidget.registry.eraseRecord(b)})},initFileInput:function(d,c,b){a("div.clone-field[id$=-upl]",this).each(function(){var i=a(this).attr("id");var h=a(document.getElementById(i)).data("fileInputParams");if(b){var f=a(this).data("saved4restore")}addFileUpload(f&&f.fileName?f.fileName:h.fileNameValue,h.setFileNameTo,h.fileExtensions,h.sizeLimit,h.hiddenFieldFileId.replace(/\[\d+\]/,"["+c+"]"),h.hiddenFieldFileName.replace(/\[\d+\]/,"["+c+"]"),h.hiddenFieldFileHash.replace(/\[\d+\]/,"["+c+"]"),h.actionURI,h.multy,h["X-AuthToken"],h["X-OrderID"],h["X-FieldName"],h["X-WithHash"]);
if(b){if(f){var e=a(this).prevAll("input:hidden[id$=.fileID]");var g=a(this).prevAll("input:hidden[id$=.fileName]");e.val(f.fileID);g.val(f.fileName);a(this).removeData("saved4restore")}}a(this).data("fileInputParams",h)})},destroyFileInput:function(){var b=this;a("div.clone-field[id$=-upl]",b).each(function(){var c=a(this).prevAll("input:hidden[id$=.fileID]");var d=a(this).prevAll("input:hidden[id$=.fileName]");a(this).data("saved4restore",{fileID:c.val(),fileName:d.val()});c.val("");d.val("");a(this).empty()})}};a.fn.clonable=function(b){if(a.descriptor.waitingForProcess){var k=this;var h=Array.prototype.slice.call(arguments,0);setTimeout(function(){a.fn.clonable.apply(k,h)},10);return}b=a.extend({},a.clonable._def,b||{});var n=j(this);var g=n.length-1;var c=n[g];var d=f(n[0]);i();a.each(n,function(){a.clonable.collection.push({$:this,opts:b})});function j(p){var o=[],q=0;a(p).each(function(){o[q]=(o[q]||a([])).add(this);if(a(this).hasClass("clone-section-splitter")){q++}});return o}function f(p){var o=a.clonable.destroyDatepicker.apply(p);
var q=p.clone(true);q.find("script").remove();q.find("*").each(function(){a(this).unbind()});a.clonable.initDatepicker.apply(p,[null,null,o]);a.clonable.destroyFileInput.apply(q);return q}function m(){var p=d.clone(true);var o=n.length;p.insertAfter(c.last());e(p,0,o,d);a.clonable.initClone.apply(p,[b,o]);a.descriptor.bind.init(p);n.push(p);if(b.hideButtonSections){c.filter(b.buttonsSection).hide(0)}c=p;g=o;i();a.descriptor.runProcess();a.clonable.collection.push({$:p,opts:b})}function l(q){var o=a.inArray(q,n);q.remove();n=n.slice(0,o).concat(n.slice(o+1));while(o<n.length){var p=n[o++];e(p,o,o-1);a.clonable.destroyDatepicker.apply(p);a.clonable.initDatepicker.apply(p);a.clonable.destroyFileInput.apply(p);a.clonable.initFileInput.apply(p,[b,o-1,"restore this value"])}i();c=n[n.length-1];a.clonable.collection=a(a.clonable.collection).filter(function(){return this.$!=q}).get()}function i(){a(n).each(function(o){var p=this;if(n.length>1){a(b.deleteBtn,p).show(0).unbind("click.deleteClone").bind("click.deleteClone",function(){l(p)
})}else{a(b.deleteBtn,p).hide(0)}if(o==n.length-1&&(b.maxContainerSize===false||n.length<b.maxContainerSize)){a(b.appendBtn,p).show(0).unbind("click").click(m)}else{a(b.appendBtn,p).hide(0)}})}function e(r,q,t,u){u=u||r;var p="["+q+"]";var o="["+t+"]";var s=a(b.reindexNodes,r).add(b.reindexCheckboxNodes,r).add(b.reindexRadioNodes,r).add(b.reindexLookupNodes,r).add(b.reindexErrNodes,r).add(b.reindexFileNodes,r);s.each(function(){var v=this;a.each(["id","name","for"],function(){var x=""+this;var z=a(v).attr(x);if(z){var w=z.replace(p,o);if(w!=z){if(x=="name"&&v.form){var y=a.validator.staticRules(v);if(u==r){a(v,u).rules("remove")}}a(v).attr(x,w);if(x=="name"&&v.form){a(v).rules("add",y)}}}})});s.each(function(){var v=a(this).data("applyDescriptorAttribute");if(v&&v.inputId){v.inputId=v.inputId.replace(p,o)}if(v&&typeof(v.initThisClone)=="function"){v.initThisClone.apply(v,[q,t,r])}});b.onAfterReindexClone&&b.onAfterReindexClone.call(r,t)}}})(jQuery);