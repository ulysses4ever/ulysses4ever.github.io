var LookupWidget=function(t){var u=this;u.State=function(v){$.extend(this,{sync:true,data:{},resultPath:[],totalPages:0,currentPage:1,searchText:""},v)};u.State.copy=function(w,v){var x=new u.State();x.sync=v;x.data=$.extend({},w.data);x.resultPath=w.resultPath.slice();x.totalPages=(v?0:w.totalPages);x.currentPage=w.currentPage;x.searchText=w.searchText;return x};u.__dynamic=null;u.__lookupURL=null;u.__sourceData={};u.__options=null;u.__dependsOn=null;u.__parentLookup=null;u.__resultFieldId=null;u.__transformFunc=null;u.__resultCallbacks=[];u.__baseId=null;u.__itemsPerPage=null;u.__dialogWidth=null;u.__elementFactory=null;u.__resources=null;u.__pendingRequest=false;u.__requestSerial=1;u.__searchTextChanged=false;u.__autoFindTimer=null;u.__cancelRequestTimer=null;u.__state=new u.State();var j=t.isDynamic,p=t.lookupURL,i=t.options,d=t.sourceData,c=t.dependsOn,n=t.parentLookup,e=t.resultFieldId,h=t.transformFunc,b=t.resultCallbacks,q=t.baseId,m=t.itemsPerPage,g=t.dialogWidth,f=t.elementFactory,s=t.resources;
if(j==null||typeof j!="boolean"){throw LookupWidget.Exception("LookupWidget","Invalid configuration.")}u.__dynamic=j;if(j&&(p==null||typeof p!="string")){throw LookupWidget.Exception("LookupWidget","Invalid configuration.")}u.__lookupURL=j?p:null;u.__sourceData.params=(d.params!=null?d.params:[]);u.__sourceData.fields=(d.fields!=null?d.fields:[]);if(j){u.__sourceData.isDictionary=d.isDictionary;if(d.terminalLevel!=null){if(typeof d.terminalLevel=="number"&&d.terminalLevel>0){u.__sourceData.terminalLevel=d.terminalLevel}else{throw LookupWidget.Exception("LookupWidget","Invalid configuration.")}}u.__sourceData.remotePaging=true;if(d.isHierarchySupport){u.__sourceData.dictionaryCode=t.optionsMap.dictionaryCode}else{u.__sourceData.dictionaryCode=d.dictionaryCode}u.__sourceData.rootItemCode=d.rootItemCode;u.__sourceData.rootItemText=d.rootItemText}else{u.__sourceData.remotePaging=false;var o=$.extend({},d.staticData);if(o.items==null){o.items=[]}u.__sourceData.staticData=o}u.__sourceData.title=(d.title!=null?d.title:null);
u.__sourceData.valueCode=d.valueCode;u.__options=$.extend({},(d.isDictionary?LookupWidget.DEFAULT_DICTIONARY_OPTIONS:LookupWidget.DEFAULT_NON_DICTIONARY_OPTIONS));if(i!=null){$.extend(u.__options,i)}u.__dependsOn=[];if(c!=null){for(var k=0;k<c.length;k++){var r=c[k];var a={};if(r.fieldId==null){throw LookupWidget.Exception("LookupWidget","Invalid configuration.")}a.fieldId=r.fieldId;if(r.check!=null){if(typeof r.check=="function"){a.check=r.check}else{throw LookupWidget.Exception("LookupWidget","Invalid configuration.")}}u.__dependsOn.push(a)}}if(n!=null){if(n.fieldId==null){throw LookupWidget.Exception("LookupWidget","Invalid configuration.")}u.__parentLookup={};u.__parentLookup.fieldId=n.fieldId;if(n.dependency!=null){if(typeof n.dependency!="function"){throw LookupWidget.Exception("LookupWidget","Invalid configuration.")}u.__parentLookup.dependency=n.dependency}}u._searchTextInitVal=t.searchTextInitVal;u._searchTextSourceId=t.searchTextSourceId;u.__resultFieldId=(e!=null?e:null);u.__transformFunc=(h!=null?h:null);
u.__resultCallbacks=[];if(b!=null){for(var l=0;l<b.length;l++){u.addResultCallback(b[l])}}u.__baseId=q;u.__itemsPerPage=m;u.__dialogWidth=g;u.__elementFactory=new LookupWidget.ElementFactory(f);u.__elementFactory.lookupWidget=u;u.__resources=$.extend({},s);u.__optionsMap=t.optionsMap;u._onChange=t.onChange;u.__runtimeHash=i.__runtimeHash||{};u._optionsMapSources=t.optionsMapSources||[];$.each(u._optionsMapSources,function(){var v=$.descriptor.$select(this.fieldId).not($(document.getElementById(u.__resultFieldId)));this.preventClear||v.change(function(){u._clearResult_()})});u.__config=t};LookupWidget.AUTOFIND_IDLE_THRESHOLD=2000;LookupWidget.RESPONSE_TIMEOUT=60000;LookupWidget.DEFAULT_DICTIONARY_OPTIONS={search:true,level:true,paging:true,selectedPath:true,selectButton:false,itemsZebra:true};LookupWidget.DEFAULT_NON_DICTIONARY_OPTIONS={search:true,level:true,paging:true,selectedPath:false,selectButton:false,itemsZebra:true};LookupWidget.Registry=function(){this.__fieldIds=[];this.__records={}
};LookupWidget.Registry.prototype.createRecord=function(a,b){if(this.__records[a]===undefined){this.__fieldIds.push(a);this.__records[a]={config:b,widget:null}}return this.__records[a]};LookupWidget.Registry.prototype.eraseRecord=function(a){if(this.__records[a]!==undefined){delete this.__records[a];for(var b=0;b<this.__fieldIds.length;b++){if(this.__fieldIds[b]==a){this.__fieldIds.splice(b,1);break}}}};LookupWidget.Registry.prototype.enumerateRecords=function(){return this.__fieldIds.slice()};LookupWidget.Registry.prototype.getRecord=function(a){return this.__records[a]};LookupWidget.registry=new LookupWidget.Registry();LookupWidget.ElementFactory=function(a){this.__elementFactory=$.extend({},a);this.__references={}};LookupWidget.ElementFactory.prototype.createElement=function(a,b){return(this.__elementFactory[a]!==undefined?this.__elementFactory[a](this,b):null)};LookupWidget.ElementFactory.prototype.createLinkedElement=function(b,d,a,e){var c=this.createElement(b,e);if(this.__references[d]===undefined){this.__references[d]=[]
}this.__references[d][a]=c;return c};LookupWidget.ElementFactory.prototype.getLinkedElement=function(b,a){return(this.__references[b]&&this.__references[b][a])||null};LookupWidget.transform={};LookupWidget.callback={};LookupWidget.dependency={};LookupWidget.Utils={escapeSelector:function(a){return a.replace(".","\\.").replace("[","\\[").replace("]","\\]")},escapeName:function(a){return a.replace(".","_").replace("[","_").replace("]","_")}};LookupWidget.Exception=function(a,b){return"Runtime Error in "+a+": "+b};LookupWidget.initAllWidgets=function(){var a=LookupWidget.registry.enumerateRecords();for(var b=0;b<a.length;b++){var c=LookupWidget.registry.getRecord(a[b]);c.widget=new LookupWidget(c.config);c.widget.init()}};$(document).ready(LookupWidget.initAllWidgets);LookupWidget.prototype.init=function(){var d=this;d.__actions={clear:function(f){f.preventDefault();d._clearResult_();if(d.__formResultField!=null){d.__formResultField.trigger("focusout")}},open:function(f){if(d.__config.sourceData.isHierarchySupport){d.__firstHierarchyOpen=!d.__notFirstHierarchyOpen;
d.__notFirstHierarchyOpen=true;if(d.__firstHierarchyOpen){d.__sourceData.rootItemCode=d.__sourceData.rootItemCode||d.__sourceData.parentItemCode}d.__sourceData.parentItemCode=d.__sourceData.rootItemCode}d._openWidget_();d.__widget.find(".lineSHWidget").removeClass("lineSHWidgetShow")},close:function(f){d.__runtimeResultField=null;d._closeWidget_();d.__dialogCloseStarted=false},select:function(f){d._selectClick=true;d._returnResult_(d.__state);d._selectClick=false;d.dialogClose()},upLevel:function(f){f.preventDefault();d._leaveItem_()},prevPage:function(f){f.preventDefault();d._gotoPrevPage_()},nextPage:function(f){f.preventDefault();d._gotoNextPage_()},selectPage:function(f){f.preventDefault();d._selectPage_()},find:function(f){f.preventDefault();d._find_()},inputTextLastRequest:"",inputTextLastResponsed:"",inputTextKeyUp:function(f){var g=$.trim($(this).val());if(d.__actions.inputTextLastResponsed==g){clearTimeout(d.__autoFindTimer);d.__actions.inputTextLastRequest="";return}if(d.__actions.inputTextLastRequest!=g){d._activateAutoFind_();
d.__actions.inputTextLastRequest=g}},dependsOnChange:function(f){d._setActiveStatus_()},parentLookupChange:function(f){d.__onParentChange(false)}};d.__timers={autoFind:function(){d._autoFind_()},cancelRequest:function(){d._cancelRequest_()}};var b={options:d.__options,itemsPerPage:d.__itemsPerPage,dialogWidth:d.__dialogWidth,resources:d.__resources};d.__formResultField=(d.__resultFieldId!=null?$(document.getElementById(d.__resultFieldId)):null);d.__formResultField&&d.__formResultField.data("lookupWidget",d);if(d._onChange){d.__formResultField.change(function(){d._onChange.call(d)});if(d.__config.executeOnChangeOnInit){d._onChange.call(d)}}d.__formTextField=$(document.getElementById(d.__baseId+"-form-text"));d.__formClearButton=$(document.getElementById(d.__baseId+"-form-clear-button"));d.__widget=d.__elementFactory.createElement("lookup-widget",b);d.__title=d.__elementFactory.getLinkedElement("title-block",0);if(d.__options.selectButton){d.__selectButton=d.__elementFactory.getLinkedElement("select-button",0)
}if(d.__options.selectedPath){d.__selectedPathBlock=d.__elementFactory.getLinkedElement("selected-path-block",0)}if(d.__options.search){d.__inputText=d.__elementFactory.getLinkedElement("search-text-input",0);d.__findButton=d.__elementFactory.getLinkedElement("find-button",0)}d.__upButton=d.__elementFactory.getLinkedElement("up-button",0);if(d.__options.paging){d.__prevButton=d.__elementFactory.getLinkedElement("prev-button",0);d.__nextButton=d.__elementFactory.getLinkedElement("next-button",0);d.__pageButton=d.__elementFactory.getLinkedElement("page-button",0)}d.__listContainer=d.__elementFactory.getLinkedElement("list-container",0);d.__maskLayer=d.__elementFactory.getLinkedElement("mask-layer",0);d.__widget.dialog({autoOpen:false,width:d.__dialogWidth,height:"auto",modal:true,resizable:false,draggable:false,closeText:"Закрыть",show:"blind",hide:"blind",open:d.__actions.open,close:d.__actions.close});if(d.__options.selectButton){d.__selectButton.click(d.__actions.select)}if(d.__options.search){d.__inputText.keyup(d.__actions.inputTextKeyUp);
d.__findButton.click(d.__actions.find)}if(d.__options.level){d.__upButton.click(d.__actions.upLevel)}if(d.__options.paging){d.__prevButton.click(d.__actions.prevPage);d.__prevButton.dblclick(d.__actions.prevPage);d.__nextButton.click(d.__actions.nextPage);d.__nextButton.dblclick(d.__actions.nextPage);d.__pageButton.click(d.__actions.selectPage)}d._clearNavigation_();d.__dependsOnRecs=[];for(var c=0;c<d.__dependsOn.length;c++){var e=d.__dependsOn[c];var a={};a.field=$(document.getElementById(e.fieldId));a.check=e.check;d.__dependsOnRecs.push(a);a.field.change(d.__actions.dependsOnChange)}d.__parentLookupField=(d.__parentLookup!=null?$(document.getElementById(d.__parentLookup.fieldId)):null);if(d.__parentLookupField!=null){d.__parentLookupField.change(d.__actions.parentLookupChange)}d.__formTextField.click(function(h){if(!d.__isScrollHeightInited){if(d.__options.scrollingHeight){var g=d.__elementFactory.getLinkedElement("list-container",0).parents("div.scrollWrap:first");g.css("height",d.__options.scrollingHeight+"px")
}d.__isScrollHeightInited=true}var f=$.fn.focus;$.fn.focus=function(){return this};d.__widget.dialog("open");$.fn.focus=f;if(!d.__config.isDynamic){d._scrollingInit()}d.renewPosition()});d.__formClearButton.click(d.__actions.clear);d._setActiveStatus_();d.__onParentChange(true)};LookupWidget.prototype.addResultCallback=function(b){var a=this;if(typeof b!="function"){throw new LookupWidget.Exception("addResultCallback","Callback must be a Function.")}a.__resultCallbacks.push(b)};LookupWidget.prototype.removeResultCallback=function(c){var b=this;for(var a=0;a<b.__resultCallbacks.length;a++){if(b.__resultCallbacks[a]===c){b.__resultCallbacks.splice(a,1);break}}};LookupWidget.prototype._setActiveStatus_=function(){var c=this;if(!c.__formResultField){return}var f=true;for(var e=0;e<c.__dependsOnRecs.length;e++){var b=c.__dependsOnRecs[e];var d=b.field.val();f=f&&(b.check!=null?b.check(d):d!="");if(!f){break}}if(f){var g=c.__formResultField.val();var a=c.__formResultField.hasClass("json")?(g&&g!="[]"):g;
c.__formClearButton[a?"show":"hide"]()}c.__formResultField.attr("disabled",!f);c.__formTextField.attr("disabled",!f);$(c.__formTextField).parents(".inputBasicWrap")[f?"removeClass":"addClass"]("fieldDisabled")};LookupWidget.prototype.__onParentChange=function(a){var c=this;if(c.__parentLookup==null){return}var e=LookupWidget.registry.getRecord(c.__parentLookup.fieldId);if(e!=null){var b=e.config["sourceData"];if(b.isDictionary){var d=c.__parentLookupField.val();if(d!=""){c.__sourceData.parentDictionaryCode=b.dictionaryCode;c.__sourceData.parentItemCode=c.__sourceData.rootItemCode=(c.__parentLookup.dependency!=null?c.__parentLookup.dependency(d):d)}}else{c.__sourceData.parentItemCode=c.__parentLookupField.val();if(b.isHierarchySupport&&c.__parentLookupField.val()){c.__sourceData.parentDictionaryCode=e.widget.__sourceData.dictionaryCode}}if(!a){c._clearResult_()}}};LookupWidget.prototype._clearResult_=function(b){var a=this;a.__formTextField.val(a.__options.promptText!=null?a.__options.promptText:"").change();
if(a.__formResultField!=null){a.__formResultField.val("");b||a.__formResultField.change()}if(a.__formResultField!=null){a.__formClearButton.hide()}};LookupWidget.prototype._openWidget_=function(){var a=this;var b=new a.State;if(a.__options.savePath&&a.__options._savedPath){b.resultPath=a.__options._savedPath}if(a._searchTextSourceId){var c=$(document.getElementById(a._searchTextSourceId));b.searchText=c.val()}else{if(a._searchTextInitVal){b.searchText=a._searchTextInitVal}}a._setSearchText_(b);a._updateWidget_(b)};LookupWidget.prototype._scrollingInit=function(b,e){var d=this;var c=d.__elementFactory.getLinkedElement("list-container",0).parents("div.scrollWrap:first");var f=!c.data("jsp");if(f){c.jScrollPane({showArrows:true,scrollbarWidth:25});if(d.__dynamic){var h=false;c.bind("jsp-scroll-y",function(m,l,j){if(a.getContentPositionY()>g.outerHeight()/2){var i=d.__state;if(i.currentPage<i.totalPages&&!h){var k=d.State.copy(i,true);k.searchText=d.__inputText.val();k.currentPage=i.currentPage+1;
d._updateWidget_(k,function(){h=false});h=true}}})}}var a=c.data("jsp");var g=a&&a.getContentPane();if(!f){b&&a.scrollTo(0,0);if($.browser.msie){setTimeout(function(){a.reinitialise();a.reinitialise()})}else{a.reinitialise()}}};LookupWidget.prototype._closeWidget_=function(){var a=this;if(a.__options.search&&a.__autoFindTimer!=null){clearInterval(a.__autoFindTimer);a.__autoFindTimer=null}a._cancelRequest_();if(a.__options.savePath){a.__options._savedPath=a.__state.resultPath}a._clearWidget_()};LookupWidget.prototype._find_=function(){var a=this;var b=a.State.copy(a.__state,true);b.searchText=a.__inputText.val();b.currentPage=1;a._updateWidget_(b)};LookupWidget.prototype._gotoPrevPage_=function(){var a=this;if(a.__state.currentPage>1){var b=a.State.copy(a.__state,a.__sourceData.remotePaging);b.currentPage--;a._updateWidget_(b)}};LookupWidget.prototype._gotoNextPage_=function(){var a=this;if(a.__state.currentPage<a.__state.totalPages){var b=a.State.copy(a.__state,a.__sourceData.remotePaging);
b.currentPage++;a._updateWidget_(b)}};LookupWidget.prototype._selectPage_=function(){};LookupWidget.prototype._activateAutoFind_=function(){var a=this;if(a.__autoFindTimer!=null){clearTimeout(a.__autoFindTimer)}a.__autoFindTimer=setTimeout(a.__timers.autoFind,LookupWidget.AUTOFIND_IDLE_THRESHOLD)};LookupWidget.prototype._autoFind_=function(){var a=this;a.__autoFindTimer=null;var b=a.State.copy(a.__state,true);b.searchText=$.trim(a.__inputText.val());b.currentPage=1;a._updateWidget_(b,function(){a.__actions.inputTextLastResponsed=b.searchText})};LookupWidget.prototype._cancelRequest_=function(a,c){var b=this;if(b.__cancelRequestTimer!=null){clearTimeout(b.__cancelRequestTimer);b.__cancelRequestTimer=null}b.__requestSerial++;b.__pendingRequest=false};LookupWidget.prototype._updateWidget_=function(b,c){var a=this;a.__dynamic?a._updateDynamicWidget_(b,c):a._updateStaticWidget_(b)};LookupWidget.prototype._updateStaticWidget_=function(d){var c=this;if(d.sync){var f=(c.__sourceData.title!=null?c.__sourceData.title:(c.__sourceData.staticData["title"]!=null?c.__sourceData.staticData["title"]:""));
var g=(d.resultPath.length>0?d.resultPath[d.resultPath.length-1]["items"]:c.__sourceData.staticData["items"]);var b=[];var e=c._getSearchText_(d);if(e!=null){for(var a=0;a<g.length;a++){if(g[a]["text"].toLowerCase().startsWith(e.toLowerCase())){b.push(g[a])}}}else{b=g.slice()}d.data={title:f,items:b}}c._doUpdateWidget_(d)};LookupWidget.prototype._requestData_=function(b,c){var a=this;if(!a.__pendingRequest){a.__pendingRequest=true;a._maskWidget_();$.getJSON(a.__lookupURL,a._buildRequestObject_(b),function(d){if(d.items.length==1&&d.items[0].code=="lookupException"){return a.__cancelRequestCallback(d.items[0].text?d.items[0].text:undefined)}a.__widget.find("span.no_data_msg").remove();a._receiveDataAsync_(d,c)});a.__cancelRequestCallback=function(d){a.__timers.cancelRequest();var e=a.__elementFactory.getLinkedElement("list-container",0);e.find("span.no_data_msg").remove();a._clearList_();$('<span style="color:red" class="no_data_msg" />').text(d?d:"Не удалось получить данные. Приносим свои извинения.").appendTo(e);
e.parents("tr:first").show();a._unmaskWidget_()};a.__cancelRequestTimer=setTimeout(a.__cancelRequestCallback,LookupWidget.RESPONSE_TIMEOUT)}};LookupWidget.prototype._buildRequestObject_=function(a){var g=this;function e(m){var k=null;if(m!=null){k="";for(var l=0;l<m.length;l++){k+=":"+String(m.charCodeAt(l))}k=k.substr(1)}return k}var i={serial:String(g.__requestSerial)};if(g.__sourceData.isDictionary){i.dictionaryCode=g.__sourceData.dictionaryCode;if(g.__sourceData.parentDictionaryCode){i.parentDictionaryCode=g.__sourceData.parentDictionaryCode}if(a.resultPath=="this is root"){a.resultPath=[];i.parentItemCode=g.__sourceData.rootItemCode}else{if(a.resultPath.length>0){i.parentItemCode=a.resultPath[a.resultPath.length-1]["code"]}else{if(g.__sourceData.rootItemCode!=null){i.parentItemCode=(g.__sourceData._valueCodeReaded?false:g.__sourceData.valueCode)||g.__sourceData.rootItemCode;g.__sourceData._valueCodeReaded=true}else{if(g.__sourceData.parentItemCode){i.parentItemCode=g.__sourceData.parentItemCode
}}}}i.getBreadCrumbs=!a.resultPath.length&&(i.parentItemCode&&i.parentItemCode!=g.__sourceData.rootItemCode)?1:""}else{if(g.__sourceData.parentItemCode){i.parentItemCode=g.__sourceData.parentItemCode}if(g.__config.sourceData.isHierarchySupport){if(g.__sourceData.parentDictionaryCode){i.parentDictionaryCode=g.__sourceData.parentDictionaryCode}}}if(g.__sourceData.remotePaging){i.itemsPerPage=g.__itemsPerPage;i.pageIndex=a.currentPage}var j=g._getSearchText_(a);if(j!=null){i.searchText=e(j)}if(g.__sourceData.params!=null){var b=g.__sourceData.params;for(var f=0;f<b.length;f++){i["param_"+b[f]["name"]]=b[f]["value"]}}if(g.__sourceData.fields!=null){var c=g.__sourceData.fields;for(var d=0;d<c.length;d++){var h=$(document.getElementById(c[d]));if(h.length==1){i["form_"+LookupWidget.Utils.escapeName(c[d])]=h.val()}}}i.optionsMap=g.__optionsMap||{};$(g._optionsMapSources||[]).each(function(){var l;if(-1!=this.fieldId.indexOf("[]")){var k=$.descriptor.$select(this.fieldId);l=k.map(function(){return $(this).val()
}).get()}else{l=$(document.getElementById(this.fieldId)).val()}i.optionsMap[this.alias||this.fieldId]=l});i.optionsMap=$.toJSON(i.optionsMap);return i};LookupWidget.prototype._receiveDataAsync_=function(a,c){var b=this;if(a.serial==String(b.__requestSerial)){if(b.__cancelRequestTimer!=null){clearTimeout(b.__cancelRequestTimer);b.__cancelRequestTimer=null}b.__requestSerial++;c(a);b._unmaskWidget_()}};LookupWidget.prototype._updateDynamicWidget_=function(b,c){var a=this;if(b.sync){a._requestData_(b,function(d){a._updateDynamicWidgetAsync_(b,d);c&&c.apply(this,arguments)})}else{a._doUpdateWidget_(b);if(a.__options.scrolling){a._scrollingInit()}}};LookupWidget.prototype._updateDynamicWidgetAsync_=function(c,a){var b=this;c.data=a;if(b.__sourceData.title!=null){c.data.title=b.__sourceData.title}if(c.data.title==null){c.data.title=""}if(c.data.plain==null){c.data.plain=true}if(c.data.items==null){c.data.items=[]}if(b.__sourceData.remotePaging&&c.data.total==null){c.data.total=0}c.resultPath=a.resultPath||c.resultPath;
b._doUpdateWidget_(c);if(b.__options.scrolling){b._scrollingInit()}};LookupWidget.prototype._enterItem_=function(b){var a=this;var c=a.State.copy(a.__state,true);c.currentPage=1;c.searchText="";c.resultPath.push(b);if(a.__sourceData.terminalLevel!=null&&a.__sourceData.terminalLevel<=c.resultPath.length){if(a._returnResult_(c)===false){return false}else{a.dialogClose()}}a.__dynamic?a._enterDynamicItem_(c,b):a._enterStaticItem_(c,b)};LookupWidget.prototype._leaveItem_=function(c){var a=this;var b=a.State.copy(a.__state,true);b.currentPage=1;b.searchText="";a.__dynamic?a._leaveDynamicItem_(b,c||1):a._leaveStaticItem_(b)};LookupWidget.prototype._enterStaticItem_=function(c,b){var a=this;if(b.items!=null){a._updateStaticWidget_(c)}else{a._returnResult_(c);a.dialogClose()}};LookupWidget.prototype._leaveStaticItem_=function(b){var a=this;if(b.resultPath.length>0){b.resultPath.pop();a._updateStaticWidget_(b)}};LookupWidget.prototype._enterDynamicItem_=function(c,b){var a=this;if(a.__sourceData.isDictionary&&!c.data.plain){a._requestData_(c,function(d){a._enterDynamicItemAsync_(c,d)
})}else{if(a.__config.sourceData.isHierarchySupport){a.__sourceData.parentItemCode=b.code;a._requestData_(c,function(d){a._enterDynamicItemAsync_(c,d)})}else{a._returnResult_(c);a.dialogClose()}}};LookupWidget.prototype._leaveDynamicItem_=function(b,c){var a=this;c=c||1;if(b.resultPath.length>0){while(c--){b.resultPath.pop()}if(b.resultPath.length==0){b.resultPath=a.__config.sourceData.isHierarchySupport?[]:"this is root"}if(a.__config.sourceData.isHierarchySupport){a.__sourceData.parentItemCode=b.resultPath.length?b.resultPath[0].code:null}a._requestData_(b,function(d){a._leaveDynamicItemAsync_(b,d)})}};LookupWidget.prototype._enterDynamicItemAsync_=function(c,a){var b=this;b._setSearchText_(c);if(a.items.length>0){b._updateDynamicWidgetAsync_(c,a)}else{b._returnResult_(c);b.dialogClose()}};LookupWidget.prototype.dialogClose=function(){var a=this;if(!a.__dialogCloseStarted){a.__widget.dialog("close");a.__dialogCloseStarted=true}};LookupWidget.prototype._leaveDynamicItemAsync_=function(c,a){var b=this;
b._setSearchText_(c);b._updateDynamicWidgetAsync_(c,a)};LookupWidget.prototype._doUpdateWidget_=function(c){var b=this;if(c.sync){var a=(b.__sourceData.remotePaging?Number(c.data.total):c.data.items.length);c.totalPages=b.__itemsPerPage?Math.ceil(a/b.__itemsPerPage):1}b.__state=c;if(b.__state.sync){b._setTitle_()}b._populateList_();b._updateNavigation_();b.focusToSearchText();b.__pendingRequest=false};LookupWidget.prototype._populateList_=function(){var h=this,d=h.__elementFactory;var g=d.getLinkedElement("list-container",0),e;var j=h.__state.data.items;var a=h.__sourceData.remotePaging&&!h.__options.scrolling?0:(h.__state.currentPage-1)*h.__itemsPerPage;var c=(h.__options.scrolling?a:0)+j.length;if(h.__itemsPerPage!=0){c=Math.min(a+h.__itemsPerPage,c)}var f=a;if(!h.__options.scrolling){h._clearList_();for(f=0;f<a;f++){var b=d.getLinkedElement("list-item-container",f);b&&b.hide()}}for(var b;f<c;f++){while(!(b=d.getLinkedElement("list-item-container",f))){g.append(d.createLinkedElement("list-item-container","list-item-container",f,{itemIndex:f,options:h.__options}))
}b.show();e=d.getLinkedElement("list-item-text-container",f);e.show();var k=j[h.__options.scrolling?f-a:f];var i=d.createElement("list-item-text",k);e.empty().append(i);if(h.__options.scrolling){(function(l){setTimeout(function(){var m=$(".lineSHWidgetCont",l.parent());var o=m.children();var n=m.parents(".lineSHWidget:first").removeClass("lineSHWidgetShow").removeClass("lineSHWidgetHide");if(o.height()>m.height()){n.addClass("lineSHWidgetShow");n.find(".lineSHWidgetBut").click(function(p){p.preventLookupSelect=true;n.toggleClass("lineSHWidgetShow").toggleClass("lineSHWidgetHide");h._scrollingInit()})}},300)})(i)}i.bind("click",{me:h,item:k},function(l){setTimeout(function(){if(l.preventLookupSelect){return}var n=l.data.me;var m=l.data.item;n._enterItem_(m)},1)})}do{b=d.getLinkedElement("list-item-container",f++)}while(b&&b.hide())};LookupWidget.prototype._clearList_=function(){var b=this;for(var a=0;a<b.__itemsPerPage;a++){b.__elementFactory.getLinkedElement("list-item-text-container",a).empty()
}};LookupWidget.prototype._updateNavigation_=function(){var b=this;if(b.__options.selectedPath){var a=(b.__state.resultPath.length>0?b.__state.resultPath[b.__state.resultPath.length-1]["text"]:"");if(b.__sourceData.dictionaryCode=="OKATO"&&b.__sourceData.terminalLevel==1){}else{b.__selectedPathBlock.empty().append(b.__elementFactory.createElement("selected-path-text",{text:a,showBreadCrumbs:b.__options.showBreadCrumbs,resultPath:b.__state.resultPath,lookupWidget:b}))}}if(b.__options.level){b.__upButton.css("visibility",b.__state.resultPath.length>0?"visible":"hidden")}var c={currentPage:b.__state.currentPage,totalPages:b.__state.totalPages};if(b.__options.paging){b.__pageButton.html(b.__elementFactory.createElement("page-button-text",c))}};LookupWidget.prototype._clearNavigation_=function(){var a=this;if(a.__options.selectedPath){if(a.__sourceData.dictionaryCode=="OKATO"&&a.__sourceData.terminalLevel==1){}else{a.__selectedPathBlock.empty().append(a.__elementFactory.createElement("selected-path-text",{text:""}))
}}if(a.__options.level){a.__upButton.css("visibility","hidden")}if(a.__options.paging){a.__pageButton.html(a.__elementFactory.createElement("page-button-text",{currentPage:0,totalPages:0}))}};LookupWidget.prototype._clearWidget_=function(){var a=this;a.__state=new a.State();a.__pendingRequest=false;a._clearTitle_();a._setSearchText_(a.__state);a._clearList_();a._clearNavigation_()};LookupWidget.prototype._setTitle_=function(){var a=this;if(a.__state.data.title!=""){a.__title.html(a.__state.data.title)}else{a.__title.html("&nbsp;")}};LookupWidget.prototype._clearTitle_=function(){var a=this;a.__title.html("&nbsp;")};LookupWidget.prototype._getSearchText_=function(b){var a=this;return(a.__options.search?(b.searchText!=null?b.searchText.trim():null):null)};LookupWidget.prototype._setSearchText_=function(b){var a=this;if(a.__options.search){a.__inputText.val(b.searchText)}};LookupWidget.prototype._returnResult_=function(c){var b=this;b.__state=c;if(b.__state.resultPath.length==0&&!b.__options.canReturnRoot){return
}var d;if(b.__transformFunc){d=b.__transformFunc.call(b,c.resultPath)}else{if(c.resultPath.length){d=c.resultPath[c.resultPath.length-1]}else{d={code:b.__sourceData.rootItemCode,text:b.__sourceData.rootItemText}}}if(d===false){return false}if(b.__formResultField!=null){b.__formResultField.val(d.code).change().trigger("focusout")}b.__formTextField.val(d.text).change();for(var a=0;a<b.__resultCallbacks.length;a++){b.__resultCallbacks[a].call(b,b.__state.resultPath)}b._setActiveStatus_()};LookupWidget.prototype._maskWidget_=function(){var a=this;if(a.__options.search){a.__inputText.attr("disabled",true)}a.__maskLayer.show()};LookupWidget.prototype._unmaskWidget_=function(){var a=this;a.__maskLayer.hide();if(a.__options.search){a.__inputText.attr("disabled",false)}a.focusToSearchText()};LookupWidget.prototype.focusToSearchText=function(){var a=this;if(!a.__inputText){return}function b(){var c=$("body").scrollTop();a.__inputText.focus();$("body").scrollTop(c)}setTimeout(function(){b();setTimeout(b,100)
},100)};LookupWidget.prototype.renewPosition=function(e){var d=this;var c=d.__widget.parent();var a=c.height();var b=d.__widget.data("dialog");if(a!=e){setTimeout(function(){setTimeout(function(){if(c.offset().top<$("body").scrollTop()){c.offset({top:$("body").scrollTop()})}},200)},200)}};