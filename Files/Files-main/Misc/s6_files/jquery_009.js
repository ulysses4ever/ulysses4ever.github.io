(function(a){a.fn.autosave=function(e){var d="autosaveStart";var c="autosaveFinish";var f="preventAutosave";var h="disableAutosave";var g="input[name],textarea[name],select[name]";var b={timeout:60000};return this.each(function(){var q=a(this);var i=a.extend(b,e||{});var k=i.debug||false;if(k){console.log("autosave: initializing for form[id="+q.attr("id")+"]")}var m=false;var n=false;var l=null;var j=false;function o(){l=null;if(i.url){if(m&&!n){n=true;m=false;var r={};a(g,q).each(function(s,u){var t=a(u);r[t.attr("name")]=t.val()});q.trigger(d,[q,r]);if(k){console.log("autosave: sending form data")}a.ajaxSetup({cache:false});a.ajax({type:"POST",url:i.url,data:r,dataType:"json",success:function(s){var t=false;try{if(s&&s.error&&s.error.errorCode=="0"){t=true;if(k){console.log("autosave: form successfully saved")}}else{if(k){console.warn("autosave: form saving error: ",error.errorCode)}}}finally{n=false;q.trigger(c,[q,r,t,s])}},error:function(){if(k){console.warn("autosave: form saving error: -1")
}n=false;q.trigger(c,[q,r,false,{error:{errorCode:-1,errorMessage:"Ошибка автосохранения"}}])}})}}else{if(k){console.warn("autosave: no url specified in opts for autosave")}}}function p(r){if(j){return false}m=true;if(!l&&!n){l=setTimeout(o,i.timeout);if(k){console.log("autosave: some field value changed, timer created")}}else{if(k){console.log("autosave: some field value changed, timer already on")}}return false}a(g,q).live("change",p);q.bind(h,function(){j=true;if(l){clearTimeout(l);l=null}});q.bind(f,function(){if(l){clearTimeout(l);l=null;if(k){console.log("autosave: timer switched off")}}return false})})}})(jQuery);